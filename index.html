<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Steam Code Finder ‚Äì LZT Market</title>
<style>
/* ‚Äî‚Äî ESTILO GERAL ‚Äî‚Äî */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Segoe UI,Tahoma,Verdana,sans-serif;background:linear-gradient(135deg,#1b2838 0%,#2a475e 50%,#1e3c72 100%);min-height:100vh;padding:20px;color:#fff}
.container{max-width:1000px;margin:0 auto}
h1{font-size:2.4em;color:#66c0f4;text-align:center;text-shadow:2px 2px 4px rgba(0,0,0,.5)}
header,section{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin:20px 0}
input,select{width:100%;padding:14px;border:2px solid rgba(102,192,244,.3);border-radius:10px;background:rgba(255,255,255,.1);color:#fff;font-size:15px}
label{font-weight:600;color:#66c0f4;margin-bottom:6px}
input::placeholder{color:rgba(255,255,255,.6)}
button{background:linear-gradient(45deg,#66c0f4,#4a90c2);color:#fff;border:none;padding:14px 25px;border-radius:10px;font-weight:600;cursor:pointer;transition:.3s}
button:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(102,192,244,.4)}
button:disabled{background:#6c757d;cursor:not-allowed;transform:none}
.spinner{border:4px solid rgba(255,255,255,.1);border-top:4px solid #66c0f4;border-radius:50%;width:45px;height:45px;animation:spin 1s linear infinite;margin:30px auto}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
/* ‚Äî‚Äî RESULTADOS ‚Äî‚Äî */
.account{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:20px;margin-top:15px}
.account h3{color:#66c0f4;margin-bottom:10px;font-size:18px}
.account-login{font-family:"Courier New",monospace;background:rgba(0,0,0,.25);padding:6px 10px;border-radius:6px;margin:4px 0 10px 0;display:inline-block}
.details{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:10px;font-size:14px;margin-top:10px}
.detail{background:rgba(0,0,0,.25);padding:8px;border-radius:6px}
.code-box{background:linear-gradient(45deg,#4caf50,#45a049);margin-top:15px;border-radius:12px;padding:18px;text-align:center;position:relative}
.code-box span{font-family:"Courier New",monospace;font-size:28px;letter-spacing:3px;font-weight:bold}
.copy-btn{position:absolute;top:10px;right:12px;background:rgba(255,255,255,.2);padding:5px 9px;border:none;color:#fff;border-radius:6px;font-size:12px;cursor:pointer}
.copy-btn:hover{background:rgba(255,255,255,.3)}
.error,.success{padding:14px;border-radius:10px;margin-top:15px}
.error{background:rgba(244,67,54,.25);border:1px solid rgba(244,67,54,.5)}
.success{background:rgba(76,175,80,.25);border:1px solid rgba(76,175,80,.5)}
.progress-info{background:rgba(102,192,244,.15);padding:12px;border-radius:8px;margin-top:10px;font-size:14px;border:1px solid rgba(102,192,244,.3)}
.search-status{background:rgba(255,193,7,.15);padding:10px;border-radius:6px;margin-top:10px;font-size:13px;color:rgba(255,255,255,.9);border:1px solid rgba(255,193,7,.3)}
.found-indicator{background:rgba(76,175,80,.25);padding:10px;border-radius:6px;margin-top:10px;font-size:14px;color:#fff;border:1px solid rgba(76,175,80,.5)}
</style>
</head>
<body>
<div class="container">
<header>
<h1>Steam Code Finder by dreezy store</h1>
<p>Busque contas Steam compradas na Dreezy Store e extraia o c√≥digo enviado por e-mail.</p>
</header>

<section>
<label for="login">üîç Login da Conta Steam</label>
<input id="login" placeholder="ex: clicaruimcaqqs" autocomplete="off" />
<button id="searchBtn">Buscar Conta</button>
<div id="status"></div>
</section>

<section id="results"></section>
</div>

<script>
/* ‚Äî‚Äî CONFIGURA√á√ïES ‚Äî‚Äî */
const TOKEN = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzUxMiJ9.eyJzdWIiOjI3ODg5MDEsImlzcyI6Imx6dCIsImlhdCI6MTc1MTY4MTAxNCwianRpIjoiODA5ODIzIiwic2NvcGUiOiJiYXNpYyByZWFkIHBvc3QgY29udmVyc2F0ZSBwYXltZW50IGludm9pY2UgY2hhdGJveCBtYXJrZXQifQ.l34LDDotkQQqoGPmlRqP4WM_HRZByiUmu3vdK0frD4-189LZN_we9mmOwfYIGYYIyxXDd-Wmgij8sWkOGSiDOFS4u5KiDbTirwxHi_h-jFEI76QY-1shEZXsyKhG5zzOF8Ewh5GQbcg3qUQ-cu5VlD5m3CdzJWoaZhl-HuJ47L0';
const API = 'https://api.lzt.market';
const DELAY = 1500; // 1.5s entre chamadas
let searchCancelled = false; // Flag para cancelar busca

/* ‚Äî‚Äî AJUDA ‚Äî‚Äî */
const qs = s => document.querySelector(s);
const qsi = s => document.querySelectorAll(s);
const wait = ms => new Promise(r => setTimeout(r, ms));

/* ‚Äî‚Äî N√öCLEO ‚Äî‚Äî */
async function api(endpoint, opt = {}) {
  await wait(DELAY);
  const res = await fetch(API + endpoint, {
    headers: { Authorization: `Bearer ${TOKEN}`, 'Accept': 'application/json' },
    ...opt
  });
  
  if (!res.ok) {
    const j = await res.json().catch(() => ({ error: 'Erro' }));
    throw new Error(j.error || 'HTTP ' + res.status);
  }
  
  return res.json();
}

async function getUserId() {
  const { user } = await api('/me');
  return user.user_id;
}

// NOVA FUN√á√ÉO: Busca at√© encontrar a conta espec√≠fica
async function searchUntilFound(uid, targetLogin) {
  let page = 1;
  let totalProcessed = 0;
  let totalSteamAccounts = 0;
  const maxPages = 1000; // Limite de seguran√ßa
  
  console.log(`üéØ Iniciando busca por: "${targetLogin}"`);
  searchCancelled = false;
  
  while (page <= maxPages && !searchCancelled) {
    try {
      // Atualiza status em tempo real
      qs('#status').innerHTML = `
        üîç <strong>Buscando conta "${targetLogin}"...</strong><br>
        üìÑ P√°gina atual: ${page}<br>
        üìä Contas Steam verificadas: ${totalSteamAccounts}<br>
        üìà Total de itens processados: ${totalProcessed}
      `;
      
      console.log(`üìÑ Verificando p√°gina ${page}...`);
      
      // M√∫ltiplos endpoints para m√°xima compatibilidade
      const endpoints = [
        `/user/${uid}/orders?category_id=1&page=${page}&per_page=100&order=date_desc`,
        `/user/${uid}/orders?category_id=1&page=${page}&per_page=50&order=date_desc`,
        `/user/${uid}/orders?page=${page}&per_page=100&category_id=1`,
        `/user/${uid}/orders?page=${page}&per_page=50&category_id=1&order=published_date_desc`
      ];
      
      let data = null;
      
      for (const endpoint of endpoints) {
        try {
          data = await api(endpoint);
          console.log(`‚úÖ Sucesso com: ${endpoint}`);
          break;
        } catch (err) {
          console.log(`‚ùå Falha: ${endpoint} - ${err.message}`);
          continue;
        }
      }
      
      if (!data || !data.items || !Array.isArray(data.items)) {
        console.log(`‚ö†Ô∏è P√°gina ${page}: Dados inv√°lidos`);
        break;
      }
      
      const pageItems = data.items;
      totalProcessed += pageItems.length;
      
      console.log(`üì¶ P√°gina ${page}: ${pageItems.length} itens encontrados`);
      
      // Filtra contas Steam
      const steamItems = pageItems.filter(item => {
        return item.category_id === 1 || 
               item.category_id === '1' || 
               (item.title && item.title.toLowerCase().includes('steam')) ||
               (item.login && item.login.trim().length > 0);
      });
      
      totalSteamAccounts += steamItems.length;
      console.log(`üéÆ P√°gina ${page}: ${steamItems.length} contas Steam`);
      
      // BUSCA A CONTA ESPEC√çFICA NESTA P√ÅGINA
      for (const item of steamItems) {
        const itemLogin = (item.login || '').toLowerCase();
        const searchLogin = targetLogin.toLowerCase();
        
        // Busca exata primeiro, depois parcial
        if (itemLogin === searchLogin || 
            (itemLogin.includes(searchLogin) && searchLogin.length > 3) ||
            (searchLogin.includes(itemLogin) && itemLogin.length > 3)) {
          
          console.log(`üéØ CONTA ENCONTRADA!`);
          console.log(`   ‚Ä¢ Login: ${item.login}`);
          console.log(`   ‚Ä¢ ID: ${item.item_id}`);
          console.log(`   ‚Ä¢ P√°gina: ${page}`);
          console.log(`   ‚Ä¢ Ap√≥s verificar ${totalSteamAccounts} contas Steam`);
          
          return {
            found: true,
            account: item,
            stats: {
              totalPages: page,
              totalProcessed,
              totalSteamAccounts,
              foundOnPage: page
            }
          };
        }
      }
      
      // Se n√£o h√° mais itens, para a busca
      if (pageItems.length === 0) {
        console.log(`üèÅ P√°gina ${page}: Vazia - fim da busca`);
        break;
      }
      
      // Se retornou menos que o esperado, pode ser √∫ltima p√°gina
      if (pageItems.length < 50) {
        console.log(`üèÅ P√°gina ${page}: Menos itens - poss√≠vel √∫ltima p√°gina`);
        // Mas continua para verificar se h√° mais p√°ginas
      }
      
      page++;
      
    } catch (error) {
      console.log(`‚ùå Erro na p√°gina ${page}: ${error.message}`);
      page++;
      
      // Se muitos erros consecutivos, para
      if (page > 10 && totalProcessed === 0) {
        console.log(`üõë Muitos erros consecutivos, parando busca`);
        break;
      }
    }
  }
  
  // Conta n√£o encontrada
  console.log(`‚ùå Busca conclu√≠da sem encontrar "${targetLogin}"`);
  console.log(`   ‚Ä¢ P√°ginas verificadas: ${page - 1}`);
  console.log(`   ‚Ä¢ Contas Steam verificadas: ${totalSteamAccounts}`);
  console.log(`   ‚Ä¢ Total processado: ${totalProcessed}`);
  
  return {
    found: false,
    stats: {
      totalPages: page - 1,
      totalProcessed,
      totalSteamAccounts
    }
  };
}

function renderError(msg) {
  qs('#results').innerHTML = `<div class="error">${msg}</div>`;
}

function copy(text, e) {
  navigator.clipboard.writeText(text).then(() => {
    const o = e.target.textContent;
    e.target.textContent = '‚úÖ Copiado!';
    setTimeout(() => e.target.textContent = o, 1500);
  });
}

/* ‚Äî‚Äî OBT√âM C√ìDIGO ‚Äî‚Äî */
async function fetchCode(itemId, email) {
  const paths = [
    `/${itemId}/email-code?email=${encodeURIComponent(email)}`,
    `/${itemId}/email-code`,
    `/market/${itemId}/email-code?email=${encodeURIComponent(email)}`,
    `/market/${itemId}/email-code`
  ];
  
  for (const p of paths) {
    try {
      const d = await api(p);
      if (d?.codeData?.code) return d.codeData;
    } catch (err) {
      continue;
    }
  }
  
  throw new Error('C√≥digo n√£o localizado');
}

/* ‚Äî‚Äî BUSCA PRINCIPAL ‚Äî‚Äî */
qs('#searchBtn').onclick = async () => {
  const login = qs('#login').value.trim();
  if (!login) return renderError('Informe o login exato da conta Steam.');
  
  qs('#results').innerHTML = '';
  qs('#status').innerHTML = 'üîÑ Iniciando busca inteligente...';
  
  // Muda bot√£o para cancelar
  const btn = qs('#searchBtn');
  const originalText = btn.textContent;
  btn.textContent = 'Cancelar Busca';
  btn.onclick = () => {
    searchCancelled = true;
    btn.textContent = originalText;
    btn.onclick = qs('#searchBtn').onclick;
    qs('#status').innerHTML = '‚ùå Busca cancelada pelo usu√°rio';
  };
  
  try {
    const uid = await getUserId();
    console.log(`üë§ ID do usu√°rio: ${uid}`);
    
    // BUSCA CONT√çNUA AT√â ENCONTRAR
    const result = await searchUntilFound(uid, login);
    
    // Restaura bot√£o
    btn.textContent = originalText;
    btn.onclick = qs('#searchBtn').onclick;
    
    if (searchCancelled) {
      qs('#status').innerHTML = '‚ùå Busca cancelada';
      return;
    }
    
    if (!result.found) {
      qs('#status').textContent = '';
      const statsMsg = `
        <div class="search-status">
          üîç <strong>Busca Completa Realizada:</strong><br>
          ‚Ä¢ P√°ginas verificadas: ${result.stats.totalPages}<br>
          ‚Ä¢ Contas Steam verificadas: ${result.stats.totalSteamAccounts}<br>
          ‚Ä¢ Total de itens processados: ${result.stats.totalProcessed}
        </div>
      `;
      return renderError(`Conta "${login}" n√£o encontrada ap√≥s busca completa.${statsMsg}`);
    }
    
    // CONTA ENCONTRADA!
    const account = result.account;
    const accountDate = new Date(account.published_date * 1000).toLocaleString('pt-BR');
    
    const html = `
      <div class="account">
        <h3>${account.title || 'Sem t√≠tulo'}</h3>
        <div class="account-login">${account.login}</div>
        <div class="details">
          <div class="detail">ID: ${account.item_id}</div>
          <div class="detail">Data: ${accountDate}</div>
          <div class="detail">Estado: ${account.item_state || 'N/A'}</div>
        </div>
        <button class="get-code-btn">üìß Obter C√≥digo</button>
        <div class="found-indicator">
          ‚úÖ <strong>Conta encontrada!</strong><br>
          ‚Ä¢ Encontrada na p√°gina: ${result.stats.foundOnPage}<br>
          ‚Ä¢ P√°ginas verificadas: ${result.stats.totalPages}<br>
          ‚Ä¢ Contas Steam verificadas: ${result.stats.totalSteamAccounts}<br>
          ‚Ä¢ Total processado: ${result.stats.totalProcessed}
        </div>
      </div>
    `;
    
    qs('#results').innerHTML = html;
    qs('#status').textContent = '';
    
    // Event listener para obter c√≥digo
    qs('.get-code-btn').onclick = async e => {
      e.target.disabled = true;
      e.target.textContent = '‚è≥ Buscando c√≥digo...';
      
      try {
        const data = await fetchCode(account.item_id, account.temp_email || account.login);
        const codeBox = `
          <div class="code-box">
            <span>${data.code}</span>
            <button class="copy-btn" onclick="copy('${data.code}', event)">Copiar</button>
          </div>
        `;
        e.target.insertAdjacentHTML('afterend', codeBox);
        e.target.textContent = '‚úÖ C√≥digo Obtido';
      } catch (err) {
        renderError('Erro ao obter c√≥digo: ' + err.message);
        e.target.textContent = 'Tentar novamente';
        e.target.disabled = false;
      }
    };
    
  } catch (err) {
    console.log('‚ùå Erro geral:', err);
    renderError('Erro geral: ' + err.message);
    qs('#status').textContent = '';
    // Restaura bot√£o
    btn.textContent = originalText;
    btn.onclick = qs('#searchBtn').onclick;
  }
};
</script>
</body>
</html>
